<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.1/css/select2.min.css" />
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.1/js/select2.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.10/handlebars.min.js"></script>
<script  type="text/x-handlebars-template" id="prescriptiontable2">
	{{#newprescription}}
	<tr>
		<td>{{med_type}}</td>
		<td>{{med_name}}</td>
		<td>{{dosage}}</td>
		<td>{{frequency}}</td>
		<td>{{course}}</td>
		<td>{{med_intake}}</td>
		<td>{{remarks}}</td>
		<td>
			<span class="edit" id="e_{{prescription_id}}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></span>
			<span class="delete" id="d_{{prescription_id}}"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i></span>
		</td>
	</tr>
	{{/newprescription}}
</script>
<div class="col-xs-12 appointment-details">
	<div class="form">
		<form id="form5" method="post">
			<div class="form-group">

				<div class="col-2 pull-right">
					<button type="button" class="close" id="pres_close" aria-label="Close">
						<span id="close-button2" aria-hidden="true"><h3>&times;</h3></span>
					</button>
				</div>
			</div>
			<div class="row">
				<div class="col-2">
					<select class="custom-select form-control form-control-sm" name="med_type" required>
						<option value="Pills">Pills</option>
						<option value="Injection">Injection</option>
						<option value="Syrup">Syrup</option>
					</select>
				</div>
				<div class="col-6">
					<select class="med_search2 form-control" name="med_search2" id="med_search2">
						<option>Medicine name</option>
					</select>
					<input type="text" class="hidden-xs-up" name="med_name" id="med_name">
				</div>
				<div class="col-4 dosage">
					<div class="row">
						<select class="custom-select col-6 form-control-sm" name="dosage">
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
							<option value="5">5</option>
						</select>
						<div class="medicin-unit col-6">
							<div class="btn-group" data-toggle="buttons">
								<label class="btn btn-light btn-sm active dosage-mg">
									<input type="radio" name="dosage_uom" value="mg" id="option1" autocomplete="off" checked> MG
								</label>
								<label class="btn btn-light btn-sm dosage-ml">
									<input type="radio" name="dosage_uom" value="ml" id="option2" autocomplete="off"> ML
								</label>
							</div>
						</div>
					</div>
				</div>

			</div>


			<div class="timings mt-3">
				<ul class="nav nav-tabs">
					<li class="active"><a data-toggle="tab" href="#standard">Standard</a></li>
					<li><a data-toggle="tab" href="#timeline">Timeline</a></li>
					<li><a data-toggle="tab" href="#freetext">Freetext</a></li>
				</ul>
				<div class="tab-content">
					<div id="standard" class="tab-pane fade in active">
						<div class="row">
							<div class="col-4">
								<label class="custom-control custom-checkbox line mb-2 mr-sm-2 mb-sm-0">
									<input type="checkbox" class="custom-control-input">
									<span class="custom-control-indicator"></span>
									<span class="custom-control-description">Morning </span>
								</label>
							</div>
							<div class="col-4">
								<label class="custom-control custom-checkbox line mb-2 mr-sm-2 mb-sm-0">
									<input type="checkbox" class="custom-control-input">
									<span class="custom-control-indicator"></span>
									<span class="custom-control-description">Afternoon</span>
								</label>
							</div>
							<div class="col-4">
								<label class="custom-control custom-checkbox mb-2 mr-sm-2 mb-sm-0">
									<input type="checkbox" class="custom-control-input">
									<span class="custom-control-indicator"></span>
									<span class="custom-control-description">Night</span>
								</label>
							</div>
						</div>
					</div>
					<div id="timeline" class="tab-pane fade">

						<p>Time line UI has tobe created</p>
					</div>
					<div id="freetext" class="tab-pane fade">
						<input type="text" name="med_dosage_text" placeholder="specify" class="form-control">
					</div>
				</div>


			</div>

			<div class="form-group row mt-3">

				<div class="col-sm-3">
					<input type="number" name="course" placeholder="Duration" class="form-control form-control-sm">
				</div>
				<div class="col-sm-5">
					<label class="custom-control custom-radio">
						<input id="days" name="duration" type="radio" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Days</span>
					</label>
					<label class="custom-control custom-radio">
						<input id="weeks" name="duration" type="radio" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Weeks</span>
					</label>
					<label class="custom-control custom-radio">
						<input id="months" name="duration" type="radio" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Months</span>
					</label>
				</div>
				<div class="col-sm-4">
					<label class="custom-control custom-radio">
						<input id="weeks" name="med_intake" type="radio" value="Before Food"  class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Before Food</span>
					</label>
					<label class="custom-control custom-radio">
						<input id="months" name="med_intake" type="radio" value="After Food" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">After Food</span>
					</label>
				</div>
			</div>

			<div class="form-group">
				<textarea class="form-control" id="exampleTextarea" name="remarks" placeholder="remarks..." rows="3"></textarea>
			</div>

			<div class="form-group rows">
				<button class="btn btn-success" id="add-prescription2">Add</button>

			</div>
		</form>
	</div>
	<hr/>
	<div>
		<div class="row">
			<div class="col-7">
				<b>Prescribed Medications</b>
			</div>
			<div class="col-3 pull-right">
				<select class="template_name2 form-control" name="template_name2" id="template_name2">	</select>
			</div>
			<div class="col-1">
				<div id="add2" class="btn btn-default fa fa-plus float-right btn-primary btn-sm"></div>
			</div>
		</div>


		<table class="table table-sm">
			<thead>
			<tr>
				<th><b>Type of Medicine</b></th>
				<th><b>Name of Medicine</b></th>
				<th><b>Dosage</b></th>
				<th><b>Timings</b></th>
				<th><b>Course Duration</b></th>
				<th><b>Medicine Intake</b></th>
				<th><b>Instructions</b></th>
				<th id="strong"><b>Action</b></th>
			</tr>
			</thead>
			<tbody id="tab3">
			<tr >
				<td>
					Please add Prescriptions.
				</td>
			</tr>

			</tbody>
		</table>
		<button class="btn btn-primary" id="save_continue">Save & Continue</button>
	</div>

</div>

<script type="text/javascript">
    $(document).ready(function() {
        var prescription_data = [];
        $("#template_name2").select2({
            width: '200px',
            tags: true,
            placeholder: "Search for a template",
            allowClear: true,
            containerCssClass : "custom-select",
            ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                type: "post",
                url: base_url+"/api/getPrescriptionTemplateList.php",
                dataType: 'json',
           //     contentType: 'application/json; charset=UTF-8',
                quietMillis: 250,
                data: function (term) {
                    return JSON.stringify({
                        template_input : {
                        	doctor_id: doctor_id,
                          	//doctor_id: 1,
                            template_id: "",
                            template_name2:term.term,
                            speciality: ""
                        }
                    })
                },
                processResults: function (data) { // parse the results into the format expected by Select2.
                    // since we are using custom formatting functions we do not need to alter the remote JSON data

                    return {
                        results: $.map(data.template_det, function (smthg) {
                            return {id: smthg.template_id, text: smthg.template_name2}
                        })
                    };
                }
            },
            cache: true
		}).addClass('custom-select ');

        $('#template_name2').on('select2:select', function (e) {
            template_id=$("#template_name").val();
            getData.getMyprescriptionTemplateDetails(template_id).then(function (res) {
                showPrescriptions(res.prescription_details);
            });
        });

        $("#med_search2").select2({
            width: '300px',
            tags: true,
            minimumInputLength: 3,
            placeholder: "Select a medicine",
            allowClear: true,
            ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                type: "post",
                url: base_url+"/api/getMymedicineList.php",
                dataType: 'json',
             //   contentType: 'application/json; charset=UTF-8',
                quietMillis: 250,
                data: function (term) {
					return JSON.stringify({
					    medicine_list: {
                            doctor_id: doctor_id,
                            //doctor_id:1,
							med_name: term.term
                        }
                    })
                },
                processResults: function (data) { // parse the results into the format expected by Select2.
                    // since we are using custom formatting functions we do not need to alter the remote JSON data

                    return {
                        results: $.map(data.my_medicine, function (smthg) {
                            return {id: smthg.med_brand_name, text: smthg.med_brand_name}
                        })
                    };
                }
            },
            cache: true
            // formatSelection: formatSelection
        });

        $("select").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);

            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });
        $('#med_search2').change(function(){
            var med_name = $('#med_search2').val();
            $("#med_name").val=med_name;
          // alert("med name:"+med_name);
        });

        if (prescriptions_list) {
            prescription_data = prescriptions_list;
        }
        $('.form').hide();
        $('#add2').on('click', function (ev) {
            $("#form5").get(0).reset();
            $('.form').show(1000);
            ev.stopPropagation();
        });
        $("#close-button2").on('click', function (ev) {
            $('.form').hide(1000);
            $("#form5").get(0).reset();
            $("#med_name").select2("val", "");
            ev.stopPropagation();
        })
        var showPrescriptions = function (prescriptions_list) {
            var source = $("#prescriptiontable2").html();
            var template = Handlebars.compile(source);
            var rows = prescriptions_list.map(function (data) {
                if (!data.delete_flag || data.delete_flag != 'Y') {
                    return template({newprescription: data});
                }
                //alert(({prescription:data}));
            });
            $('#tab3').html(rows.join(''));
        };
        if (apmt_status == "closed") {
            $("#add2").hide();
            $("#save_continue").hide();
            $("#strong").hide();
            $(".edit").hide();
            $(".delete").hide();
        }
        //  $("#form4").hide()
        showPrescriptions(prescription_data);
        $("#add-prescription2").click(function (evt) {
            var formData = $("#form5").serializeArray();
            evt.preventDefault();

            var data = {};
            formData.map(function (feild) {
                data[feild.name] = feild.value;
            });

            data.dosage = data.dosage + ' ' + data.dosage_uom;
            data.frequency = Number(!!data.timings_morning) + '-' + Number(!!data.timings_afternoon) + '-' + Number(!!data.timings_night);
            var duration = data.days || data.weeks || data.months;
            data.course = data.course + ' ' + duration;
            data.med_name=data.med_search2;
            if ($('.form').attr('data-id')) {
                data.prescription_id = $('.form').attr('data-id')
                prescription_data = prescription_data.filter(function (p) {
                    return p.prescription_id != data.prescription_id;
                })
            }
            prescription_data.push(data);
            showPrescriptions(prescription_data);
            $('.form').hide(1000);
            //$("#form5").get(0).reset();
        });
        $("#save_continue").on("click", function (evt) {
            getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
                showPrescriptions(res.prescription_details);
                var next = $('#mytabs li.active').next();
                next.length ?
                    next.find('a').click() :
                    $('#mytabs li a')[2].click();
            });
            evt.preventDefault();
        });
        $('#tab3').on('click', '.edit', function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            var prescription = prescription_data.filter(function (p) {
                return p.prescription_id == id
            });
            if (prescription.length) {
                prescription = prescription[0];
            }
            $('.form').attr('data-id', prescription.prescription_id);
            $('#med_search2').val(prescription.med_name);
            $('.med_type_div option[value="' + prescription.med_type + '"]').attr('selected', true);
            $('.dosage-div option[value="' + prescription.dosage.split(' ')[0] + '"]').attr('selected', true);
            $('.medicin-unit .dosage-mg').removeClass('active').addClass(prescription.dosage.split(' ')[1] == 'mg' ? 'active' : '');
            $('.medicin-unit .dosage-ml').removeClass('active').addClass(prescription.dosage.split(' ')[1] == 'ml' ? 'active' : '');
            $('.timings #mrng').removeAttr('checked').attr('checked', prescription.frequency.split('-')[0] == 1);
            $('.timings #noon').removeAttr('checked').attr('checked', prescription.frequency.split('-')[1] == 1);
            $('.timings #night').removeAttr('checked').attr('checked', prescription.frequency.split('-')[2] == 1);
            $('.timings .morning').removeClass('active').addClass(prescription.frequency.split('-')[0] == 1 ? 'active' : '');
            $('.timings .noon').removeClass('active').addClass(prescription.frequency.split('-')[1] == 1 ? 'active' : '');
            $('.timings .night').removeClass('active').addClass(prescription.frequency.split('-')[2] == 1 ? 'active' : '');
            $('input[name="med_dosage_text"]').val(prescription.med_dosage_text ? prescription.med_dosage_text : '');
            $('input[name="course"]').val(prescription.course.split(' ')[0]);
            $('input[name="' + prescription.course.split(' ')[1] + '"]').attr('checked', true);
            $('.food .food_timings_before').removeClass('active').addClass(prescription.med_intake == 'Before Food' ? 'active' : '');
            $('.food .food_timings_after').removeClass('active').addClass(prescription.med_intake == 'After Food' ? 'active' : '');
            $('textarea[name="remarks"]').text(prescription.remarks);
            $('.form').show(1000);
        });
        $('#tab3').on('click', '.delete', function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            prescription_data = prescription_data.map(function (p) {
                if (p.prescription_id == id) {
                    p.delete_flag = 'Y';
                }
                return p;
            });
            showPrescriptions(prescription_data);
        });
    })
        /*	$("#autocomplete").autocomplete(function (evt) {
                getData.getMymedicineList(med);
                evt.preventDefault();
            });
    */
            /*$("#autocomplete").autocomplete(function(evt){
                debugger
                var formData=$("#autocomplete").serializeArray();
                var data={};
                formData.map(function(feild){
                    data[feild.name]=feild.value;
                });
                medicine_data.push(data);
                getData.getMymedicineList(medicine_data);
                evt.preventDefault();
            });*/
</script>