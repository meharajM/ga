<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
<script  type="text/x-handlebars-template" id="prescriptiontable">
	{{#prescription}}
	<tr>
		<td>{{med_type}}</td>
		<td>{{med_name}}</td>
     
		<td>{{frequency_string}}</td>
		<td>{{course}}</td>
		<td>{{med_intake}}</td>
		<td>{{remarks}}</td>
		<td>

			<span class="edit" id="e_{{prescription_id}}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></span>
			<span class="delete" id="d_{{prescription_id}}"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i></span>
		</td>
	</tr>
	{{/prescription}}
</script>
<div class="col-xs-12 appointment-details">
	<div class="form">
		<form id="form3" method="post">
			<div class="form-group">

				<div class="col-2 pull-right">
					<button type="button" class="close" id="pres_close" aria-label="Close">
						<span id="close-button" aria-hidden="true"><h3>&times;</h3></span>
					</button>
				</div>
			</div>
			<div class="font-12"><b>Medicine</b></div>
			<div class="row">
				<div class="col-4">
					<select class="custom-select form-control form-control-sm" id="med_type" name="med_type" required>
						<option value="" disabled selected>Medicine Type</option>
						<option value="Tablet">Tablet</option>
						<option value="Syrup">Syrup</option>
						<option value="Drops">Drops</option>
						<option value="Suppositorie">Suppositorie</option>
						<option value="Inhaler">Inhalers</option>
						<option value="Injection">Injections</option>
						<option value="Ointment">Ointment/Cream/Lotion</option>
						<option value="Implants">Implants or patches</option>
					</select>
				</div>
				<div class="col-6">
					<div class="ui-front">
						<input class="form-input" name="med_search" id="med_search" placeholder="Medicine Name *" required>

						</input>
					</div>

				</div>
				<div class="col-2">
					<input type="text" class="form-input" name="dosage" id="dosage" placeholder="Dosage"/>
				</div>


			</div>
			<div class="mt-3">
				<div class="font-12"><b>Timings/Quantity</b></div>
				<div class="timings">
					<ul class="nav nav-tabs">
						<li><a href="#" id="standard" class="selected">Standard</a></li>
						<li><a href="#" id="free-text">Free Text</a></li>
					</ul>

					<div id="standard-tab">
						<div class="row">
							<div class="col-3">
								<div class="font-12">Morning *</div>
								<i class="fa fa-minus" aria-hidden="true" for="morning"></i>
								<input type="number" name="morning" id="morning"  class="quantity form-input" value="0" min="0">
								<i class="fa fa-plus" aria-hidden="true" for="morning"></i>

								<span class="unit"></span>
							</div>
							<div class="col-3">
								<div class="font-12">Afternoon *</div>
								<i class="fa fa-minus" aria-hidden="true" for="afternoon"></i>
								<input type="number" name="afternoon" id="afternoon" placeholder="Afternoon" class="quantity form-input" value="0" min="0">
								<i class="fa fa-plus" aria-hidden="true" for="afternoon"></i>
								<span class="unit"></span>
							</div>
							<div class="col-3">
								<div class="font-12">Night *</div>
								<i class="fa fa-minus" aria-hidden="true" for="evening"></i>
								<input type="number" name="night" id="evening" placeholder="Night" class="quantity form-input" value="0" min="0">
								<i class="fa fa-plus" aria-hidden="true" for="evening"></i>
								<span class="unit"></span>
							</div>
							<div class="col-sm-3 food">
								<label class="custom-control custom-radio">
									<input id="before-food" name="med_intake" type="radio" value="Before Food"  class="custom-control-input">
									<span class="custom-control-indicator"></span>
									<span class="custom-control-description">Before Food</span>
								</label>
								<label class="custom-control custom-radio">
									<input id="after-food" name="med_intake" type="radio" value="After Food" class="custom-control-input">
									<span class="custom-control-indicator"></span>
									<span class="custom-control-description">After Food</span>
								</label>
							</div>
						</div>
					</div>
					<div id="free-text-tab">
						<textarea name="med_dosage_text" id="timings-text" rows="3" placeholder="Provide the timings details."/>
						<div>
							Suggestions: <span id="suggestions"><a href="#">Every 3 hours</a>, <a  href="#">7:30 AM - 10:30 AM - 1:30 PM - 4:30 PM</a></span>
						</div>
					</div>


				</div>
			</div>


			<div class="mt-3">
				<div class="font-12"><b>Course Duration</b></div>
				<div class="form-group row ">

					<div class="col-sm-3">
						<input type="number" name="course" placeholder="Duration *" min=0 class="form-input">
					</div>
					<div class="col-sm-4 duration">
						<label class="custom-control custom-radio">
							<input id="days" name="duration" type="radio" value="days" class="custom-control-input">
							<span class="custom-control-indicator"></span>
							<span class="custom-control-description">Days</span>
						</label>
						<label class="custom-control custom-radio">
							<input id="weeks" name="duration" type="radio" value='weeks' class="custom-control-input">
							<span class="custom-control-indicator"></span>
							<span class="custom-control-description">Weeks</span>
						</label>
						<label class="custom-control custom-radio">
							<input id="months" name="duration" type="radio" value='months' class="custom-control-input">
							<span class="custom-control-indicator"></span>
							<span class="custom-control-description">Months</span>
						</label>
					</div>

				</div>
			</div>

			<div class="font-12"><b>Instructions</b></div>
			<div class="form-group">
				<textarea class="form-control" id="exampleTextarea" name="remarks" placeholder="Remarks..." rows="3"></textarea>
			</div>

			<div class="form-group rows">
				<button class="btn btn-success btn-sm" id="add-prescription">Add</button>
				<button class="btn btn-danger btn-sm" id="reset-prescription" type="reset">Reset</button> <span class="form-error hidden-xs-up">Please add all mandatory fields</span>

			</div>
		</form>
	</div>
	<hr/>
	<div>
		<div class="row">
			<div class="col-5">
				<b>Prescribed Medications</b>
			</div>
            <div class="col-3 pull-right">
                <select class="previous_prescription form-control" name="previous_prescription" id="previous_prescription">
                    
                </select>
            </div>
			<div class="col-3 pull-right">
				<select class="template_name form-control" name="template_name" id="template_name">	</select>
			</div>
			<div class="col-1">
				<div id="add" class="btn btn-default fa fa-plus float-right btn-primary btn-sm"></div>
			</div>
		</div>


		<table class="table table-sm prescriptions-table">
			<thead>
			<tr>
				<th><b>Type</b></th>
				<th><b>Name</b></th>
           		<th><b>Timings/Quantity</b></th>
				<th><b>Course Duration</b></th>
				<th><b>Medicine Intake</b></th>
				<th><b>Instructions</b></th>
				<th id="strong"><b>Action</b></th>
			</tr>
			</thead>
			<tbody id="tab1">
			<tr >
				<td>
					Please add Prescriptions.
				</td>
			</tr>

			</tbody>
		</table>
		<button class="btn btn-primary btn-sm" id="save_continue">Continue</button>
	</div>

</div>
<div class="template modal fade bd-example-modal-lg template-alert" id="template-alert" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="template-msg modal-dialog modal-sm" role="document">
            <div class=" modal-content">
                <div class="modal-header">
                    <span class="document-title"></span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Template</h4>
                </div>
                <div class="modal-body-template">
                Do you want to replace the existing medicines or append it?
                </div>
                <div class="modal-footer text-center">
                    <button type="button" class="btn btn-info btn-sm replace" id="replace" data-dismiss="modal" >Replace</button>
                    <button type="button" class="btn btn-primary btn-sm append" id="append" data-dismiss="modal" >Append</button>
                </div>
            </div>
        </div>
    </div>

</div>
<script type="text/javascript">
var showPrescriptions;
var prescription_data = [];
$(document).ready(function() {
  
    var prescriptionDetais = {
        Tablet: {
            unit: "No",
            baseQuantity: 0.5,
            min: 0,
            max: 10,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Capsule: {
            unit: "No",
            baseQuantity: 1,
            min: 0,
            max: 10,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Syrup: {
            unit: "Ml",
            baseQuantity: 2.5,
            min: 0,
            max: 20,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Drops: {
            unit: "Drops",
            baseQuantity: 1,
            min: 0,
            max: 10,
            element: 'freetext',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Suppositorie: {
            unit: "No",
            baseQuantity: 0.5,
            min: 0,
            max: 10,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Inhaler: {
            unit: "Ml",
            element: 'freetext',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Injection: {
            unit: "No",
            element: 'freetext',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Ointment: {
            element: "freetext",
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        Implants: {
             element: "freetext"
        }
    }

     if (apmt_status == "closed" || apmt_status == "expired") {
        $("#add").hide();
        $("#save_continue").hide();
        $("#strong").hide();
        $(".edit").hide();
        $(".delete").hide();
        $('#template_name').hide();
        $('#previous_prescription').hide();
    }


    function validateForm(formData){
        var isValid = true;
        $('.form-error').addClass('hidden-xs-up')
        $('#med_search').removeClass('error');
        $('input[name="course"]').removeClass('error');
        if(formData['med_name'] == ""){
            $('#med_search').addClass('error');
            isValid =false;
        }
        $('#med_type').removeClass('error');
        $('.quantity').removeClass('error');
        $('#timings-text').removeClass('error');

        if(formData['frequency_type'] == "std_MAE" && formData['frequency_string'] == "0-0-0"){
            $('.quantity').addClass('error');
            isValid = false;
        }else if(formData['frequency_type'] == "Others" && formData['frequency_string'].trim() == ""){
            isValid = false
        $('#timings-text').addClass('error');
        }
        if($('input[name="course"]').val() == ""){
            $('input[name="course"]').addClass('error');
            isValid = false;
        }
        if(!isValid){
            $('.form-error').removeClass('hidden-xs-up');
        }
        if(isValid == false){
            $('#add').hide();
        }else{
            $('#add').show();
        }
        return isValid;
    }

    getData.getPreviousAppointmentDate().then(function (res) {
        var result = res.previous_appointments;
        if(result != ''){
            $.each(result, function(k, v) {
                 $('#previous_prescription').append('<option value="' + v.appointment_id + '">' + v.formated_date + '</option>');
            });
        }
    });


    var selectedPrescriptionDetails = prescriptionDetais.tablet;
    function setUnit() {
        selectedPrescriptionDetails = prescriptionDetais[$('#med_type').val()];
        $('.unit').html("");
        $('.quantity').removeAttr("min");
        $('.quantity').removeAttr("max");
        if(selectedPrescriptionDetails.unit){
            $('.unit').html(selectedPrescriptionDetails.unit);
        }
        if(selectedPrescriptionDetails.min){
            $('.quantity').prop("min", selectedPrescriptionDetails.min);
        }
        if(selectedPrescriptionDetails.max){
            $('.quantity').prop("max", selectedPrescriptionDetails.max);
        }
        if(selectedPrescriptionDetails.element === "freetext"){
            $('#free-text').click();
            selectedPrescriptionDetails.suggestions && $('#suggestions').html(selectedPrescriptionDetails.suggestions.map(function (value) { return "<a href='#'>"+value+"</a>" }).join(','));
        }else{
            $('#standard').click();
        }
    }
    $('#med_type').on('change',function (ev) {
    $('#med_search').val('');
    $('#dosage').val('');
    $('#morning').val('');
    $('#afternoon').val('');
    $('#evening').val('');
    $('#before-food').prop('checked', false);
    $('#after-food').prop('checked', false);
    $('#timings-text').val('');
    setUnit();
})


$("#template_name").select2({
    width: '200px',
    tags: true,
    placeholder: "Search for a template",
    allowClear: true,
    minimumInputLength: 3,
    containerCssClass : "custom-select ",
        ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
            type: "post",
            url: base_url+"/api/getPrescriptionTemplateList.php",
            dataType: 'json',
            //contentType: 'application/json; charset=UTF-8',
            data: function (term) {
                return JSON.stringify({
                    template_input : {
                    	doctor_id: doctor_id,
                      	//doctor_id: 1,
                        template_id: 1,
                        template_name:term.term,
                        speciality: ""
                    },
                	session_info: {
                        "user_id": sessionStorage.getItem("userId"),
                        "access_token": sessionStorage.getItem("token"),
                        "device_id": "web",
                        "doctor_id": sessionStorage.getItem("doctorId")
                    }
                })
            },
            processResults: function (data) { // parse the results into the format expected by Select2.
            // since we are using custom formatting functions we do not need to alter the remote JSON data
                return {
                    results: $.map(data.template_det, function (smthg) {
                       return {id: smthg.template_id, text: smthg.template_name}
                    })
                };
            }
        },
    cache: true
}).addClass('custom-select ');


$('#template_name').on('select2:select', function (e) {
    var template_id = $(this).val();
    var template_name=$("#template_name").text();       
    getData.getMyprescriptionTemplateDetails(template_id).then(function (res) {
        $(".modal-header").html(template_name);
        $('#template-alert').modal({
             show: true
        });
    $("#replace").on("click", function (evt) {
            prescription_data = prescription_data.map(function (p) {
            	p.delete_flag = 'Y';
                return p;
            });
        prescription_data   =   prescription_data.concat(res.prescription_details);
        getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
            showPrescriptions(res.prescription_details);
        });
        evt.preventDefault();
    });
    $("#append").on("click", function (evt) {
        prescription_data = prescription_data.concat(res.prescription_details);
        getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
    	   showPrescriptions(res.prescription_details);
        });
        evt.preventDefault();
    });
});
});

/*  Code start for append and replace  */

/*  code end here for append and replace  */
    $("#med_search").autocomplete({
        minLength: 3,
        placeholder: "Search for a Medicine",
        allowClear: true,
        classes: {
          "ui-autocomplete": "menu"
        },
        source: function(req, response){
            getData.getMymedicineList(req.term).then(function(res){
                response(res.my_medicine.map(function (t) { 
                    return {label:t.med_brand_name, id:t.med_id, dosage: t.dosage }
                }));
            });;
        },
        select: function (ev, ui) {
            $('#dosage').val(ui.item.dosage);
        }
    });

    $("select").on("select2:select", function (evt) {

        var element = evt.params.data.element;
        var $element = $(element);
        $element.detach();
        $(this).append($element);
        $(this).trigger("change");
    });
    $('#med_search').change(function(){
        var med_name = $('#med_search').val();
        $("#med_name").val=med_name;
    });

    if (prescriptions_list) {
        prescription_data = prescriptions_list;
    }
    $('.form').hide();
    $('#add').on('click', function (ev) {
        $(this).hide();
        $("#form3").get(0).reset();
        $('.form').show();
        ev.stopPropagation();
        $('#add-prescription').html("Add");
    });
    $("#close-button").on('click', function (ev) {
        $('#add').show();
        $('.form').hide();
        $("#form3").get(0).reset();
        $("#med_name").val("");
        ev.stopPropagation();
    })
    showPrescriptions = function (prescriptions_list) {
        prescription_data = prescriptions_list;
        var source = $("#prescriptiontable").html();
        var template = Handlebars.compile(source);
        var rows = prescriptions_list.map(function (data) {
            if (!data.delete_flag || data.delete_flag != 'Y') {
                if(!!data.med_id){
                    data.prescription_id = data.med_id;
                }
            return template({prescription: data});
            }
        });
        $('#tab1').html(rows.join(''));
    };
    showPrescriptions(prescription_data);



    $("#add-prescription").click(function (evt) {
        var formData = $("#form3").serializeArray();
        evt.preventDefault();
        var data = {};
        formData.map(function (feild) {
            data[feild.name] = feild.value;
        });

        if(!data.med_dosage_text){
            frequency_string = data.morning + '-' + data.afternoon + '-' + data.night;
            frequency_type= "std_MAE";
        }else{
            frequency_string = data.med_dosage_text;
            frequency_type = "Others";
        }
        data.frequency_string =  frequency_string;
        data.frequency_type = frequency_type;
        data.course = data.course + ' ' + data.duration;
        data.med_name=data.med_search;
        if(validateForm(data)){
            if ($('.form').attr('data-id')) {
                data.prescription_id = $('.form').attr('data-id')
                prescription_data = prescription_data.filter(function (p) {
                    return p.prescription_id != data.prescription_id;
                })
            }
            prescription_data.push(data);
            $('.form').hide();
        }
        getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
            showPrescriptions(res.prescription_details);
        });
    });


    $("#save_continue").on("click", function (evt) {
        var next = $('#mytabs li.active').next();
        next.length ?
        next.find('a').click() :
        $('#mytabs li a')[2].click();
                evt.preventDefault();
        });
        $('#tab1').on('click', '.edit', function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            $('#add-prescription').html('Update');
            var prescription = prescription_data.filter(function (p) {
                  return p.prescription_id == id
            });
            if (prescription.length) {
                  prescription = prescription[0];
            }
            $('.form').attr('data-id', prescription.prescription_id);
            $('#med_search').val(prescription.med_name);
            $('#med_type option[value="' + prescription.med_type + '"]').attr('selected', true);
            if(prescription.frequency_type === "std_MAE"){
                $('.timings #morning').val(prescription.frequency_string.split('-')[0]);
                $('.timings #afternoon').val(prescription.frequency_string.split('-')[1]);
                $('.timings #night').val(prescription.frequency_string.split('-')[2]);
                $('#standard').click();
            }else{
                $('#timings-text').val(prescription.frequency_string);
                $('#free-text').click();
            }
            $('#dosage').val(prescription.dosage);
            $('input[name="course"]').val(prescription.course.split(' ')[0]);
            $('.duration input[value="' + prescription.course.split(' ')[1] + '"]').attr('checked', true);
            $('input[value="' + prescription.med_intake + '"]').attr('checked', true);
            $('textarea[name="remarks"]').text(prescription.remarks);
            $('.form').show();
        });
        $('#tab1').on('click', '.delete', function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            if (confirm('Are you sure want to delete this medicine?')) {
                prescription_data = prescription_data.map(function (p) {
                    if (p.prescription_id == id) {
                        p.delete_flag = 'Y';
                    }
                    return p;
            });
            getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
                     showPrescriptions(res.prescription_details);
                });
            }
        });
        $('#free-text-tab').hide();
        $('#standard').click(function (ev) {
            $('#standard').addClass('selected');
            $('#free-text').removeClass('selected');
            $('#timings-text').val('');
            $('#standard-tab').show();
            $('#free-text-tab').hide();
        });
        $('#free-text').click(function (ev) {
            $('#free-text').addClass('selected');
            $('#standard').removeClass('selected');
            $('#morning').val('');
            $('#afternoon').val('');
            $('#evening').val('');
            $('#before-food').prop('checked', false);
            $('#after-food').prop('checked', false);
            $('#standard-tab').hide();
            $('#free-text-tab').show();
        });
        $('.timings .fa-plus').on('click', function (ev) {
            var target = $(this).attr('for')
            var currentValue = $('#'+target).val();
            currentValue = !!currentValue ?Number(currentValue) : undefined;
        if(currentValue){
            currentValue+=selectedPrescriptionDetails.baseQuantity;
        }else{
            currentValue=selectedPrescriptionDetails.baseQuantity;
        }
        $('#'+target).val(currentValue);
             ev.stopPropagation();
        });
        $('.timings .fa-minus').on('click', function (ev) {
            var target = $(this).attr('for')
            var currentValue = $('#'+target).val();
            currentValue = !!currentValue ? Number(currentValue) :undefined;
            if(currentValue){
                 currentValue-=selectedPrescriptionDetails.baseQuantity;
            }else{
                currentValue=selectedPrescriptionDetails.baseQuantity;
            }
            $('#'+target).val(currentValue);
                 ev.stopPropagation();
            });
            $('#suggestions').on('click', 'a', function (ev) {
                var text = $(this).text();
                $('#timings-text').val($('#timings-text').val() + text);
            })
        })


/*$('#previous_prescription').select2({
     width: '200px',
    placeholder: "Search for previous prescrption",
    containerCssClass : "custom-select "

})*/

$('#previous_prescription').change(function(){
    var apmt_id = $(this).val();
    getData.getPrescription(apmt_id).then(function (res) {
       // prescription_data = res.prescription_details;
        $(".modal-header").html("Previous Prescriptions");
        $('.template-alert').modal({
            show: true
        });
        $(".replace").on("click", function (evt) {
           
            prescription_data = prescription_data.map(function (p) {
                p.delete_flag = 'Y';
                return p;
            });
            prescription_data   =   prescription_data.concat(res.prescription_details);
            getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
                showPrescriptions(res.prescription_details);
            });
             evt.preventDefault();
        });
        $(".append").on("click", function (evt) {
            prescription_data =prescription_data.concat(res.prescription_details);
            getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
                showPrescriptions(res.prescription_details);
            });
            evt.preventDefault();
        });
    });
})


</script>