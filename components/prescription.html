<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.10/handlebars.min.js"></script>
<script  type="text/x-handlebars-template" id="prescriptiontable">
	{{#prescription}}
	<tr>
		<td>{{med_type}}</td>
		<td>{{med_name}}</td>
		<td>{{med_dosage}}</td>
		<td>{{med_timings}}</td>
		<td>{{med_duration}}</td>
		<td>{{food_timings}}</td>
		<td>{{instructions}}</td>
		<td>
			<span class="edit" id="e_{{prescription_id}}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></span>
			<span class="delete" id="d_{{prescription_id}}"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i></span>
		</td>
	</tr>
	{{/prescription}}
</script>
<div class="col-xs-12 appointment-details">
	<div class="form">
		<form id="form3" method="post">
			<div class="form-group">
			 <div class="col-2 pull-right">
			<button type="button" class="close" id="pres_close" aria-label="Close">
				<span id="close-button" aria-hidden="true"><h3>&times;</h3></span>
			</button>
			</div>
			</div>
			<div class="form-group">
				<input type="text" placeholder="Medicine name" id="med_name" name="med_name" class="form-control" autofocus="autofocus" title="Please enter a medicine name"  required/>
				<div id="suggesstion-box"></div><p id="demo"></p>
			</div>
			<div class="form-group row">
				<label for="type" class="col-sm-2 col-form-label"><strong>Type</strong></label>
				<div class="col-sm-10 med_type_div">
					<select class="custom-select form-control" name="med_type" pattern="Select the medicine type" required>
						<option value="" selected><strong>Select medicine type</strong></option>
						<option value="Pills">Pills</option>
						<option value="Injection">Injection</option>
						<option value="Syrup">Syrup</option>
					</select>
				</div>

			</div>
			<div class="form-group row">
				<label for="type" class="col-sm-2 col-form-label"><strong>Dosages</strong></label>
				<div class="col-sm-6 dosage-div">
					<select class="custom-select form-control" name="med_dosage">
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
					</select>
				</div>
				<div class="col-sm-4 medicin-unit">
					<div class="btn-group" data-toggle="buttons">
						<label class="btn btn-light active">
							<input type="radio" name="dosage_uom" value="mg" id="option1" autocomplete="off" checked> MG
						</label>
						<label class="btn btn-light dosage-ml">
							<input type="radio" name="dosage_uom" value="ml" id="option2" autocomplete="off"> ML
						</label>
					</div>
				</div>
			</div>
			<div class="form-group row timings">
				<label for="type" class="col-sm-2 col-form-label"><strong>When</strong></label>
				<div class="col-sm-10">
					<div class="btn-group" data-toggle="buttons">
						<label class="btn btn-lg morning active">
							<input type="checkbox" name="timings_morning" id="mrng" checked autocomplete="off">
						</label>
						<label class="btn btn-lg noon">
							<input type="checkbox" name="timings_afternoon" id="noon" autocomplete="off">
						</label>
						<label class="btn btn-lg night">
							<input type="checkbox" name="timings_night" id="night" autocomplete="off">
						</label>
					</div>
				</div>
			</div>
			<div class="text-center form-group"><strong>or</strong></div>
			<div class="form-group">
				<input type="text" name="med_dosage_text" placeholder="specify" class="form-control">
			</div>
			<div class="form-group row">

				<label for="type" class="col-form-label col-sm-2"><strong>Duration</strong></label>
				<div class="col-sm-2">
					<input type="text" name="med_duration" class="form-control">
				</div>
				<div class="col-sm-5">
					<div class="btn-group duration" data-toggle="buttons">
						<label class="btn btn-sm active duration-days">
							<input type="radio" name="days" value="Days" checked autocomplete="off">Days
						</label>
						<label class="btn btn-sm duration-weeks">
							<input type="radio" name="weeks" value="Weeks" autocomplete="off">Weeks
						</label>
						<label class="btn btn-sm duration-months">
							<input type="radio" name="months" value="Months" autocomplete="off"> Months
						</label>
					</div>
				</div>
			</div>
			<div class="form-group row">
				<div class="col-sm-2">
					<label for="type" class="col-form-label"><strong>Food</strong></label>
				</div>
				<div class="col-sm-10">
					<div class="btn-group food" data-toggle="buttons">
						<label class="btn btn-sm btn-light active food_timings_before">
							<input type="radio" name="food_timings" value="Before Food" autocomplete="off" checked>Before
						</label>
						<label class="btn btn-sm btn-light food_timings_after">
							<input type="radio" name="food_timings" value="After Food" autocomplete="off">After
						</label>
					</div>
				</div>
			</div>
			<div class="form-group">
				<textarea class="form-control" id="exampleTextarea" name="instructions" placeholder="instructions..." rows="3"></textarea>
			</div>

			<div class="form-group rows">
				<button class="btn btn-success" id="add-prescription">Add</button>

			</div>
		</form>
	</div>
	<hr/>
	<div>
		<div class="row">
			<div class="col-10">
				<strong>Prescribed Medications</strong>
			</div>
			<div class="col-2">
				<div id="add" class="btn btn-default fa fa-plus float-right btn-primary btn-sm"></div>
			</div>
		</div>


		<table class="table table-sm">
			<thead>
			<tr>
				<th><b>Type of Medicine</b></th>
				<th><b>Name of Medicine</b></th>
				<th><b>Dosage</b></th>
				<th><b>Timings</b></th>
				<th><b>Course Duration</b></th>
				<th><b>Medicine Intake</b></th>
				<th><b>Instructions</b></th>
				<th id="strong"><b>Action</b></th>
			</tr>
			</thead>
			<tbody id="tab1">
			<tr >
				<td>
					Please add Prescriptions.
				</td>
			</tr>

			</tbody>
		</table>
		<button class="btn btn-primary" id="save_continue">Save & Continue</button>
	</div>

</div>

<script type="text/javascript">
    $(document).ready(function(){
        var prescription_data=[];
        if(prescriptions_list)
        {
            prescription_data=prescriptions_list;
        }
        $('.form').hide();
        $('#add').on('click', function(ev){
            $('.form').show(1000);
            ev.stopPropagation();
        });
        $("#close-button").on('click', function () {
			$('.form').hide(1000);
			ev.stopPropagation();
        })
        var showPrescriptions = function(prescriptions_list){
            var source   = $("#prescriptiontable").html();
            var template = Handlebars.compile(source);
            var rows = prescriptions_list.map(function (data) {
                if(!data.delete_flag || data.delete_flag != 'Y'){
                    return template({prescription: data});
                }
                //alert(({prescription:data}));
            });
            $('#tab1').html(rows.join(''));
        };
        if(apmt_status=="closed") {
            $("#add").hide();
            $("#save_continue").hide();
            $("#strong").hide();
            $(".edit").hide();
            $(".delete").hide();
        }
        //  $("#form4").hide()
        showPrescriptions(prescription_data);
        $("#add-prescription").click(function(evt){
            var formData=$("#form3").serializeArray();
            evt.preventDefault();

            var data={};
            formData.map(function(feild){
                data[feild.name]=feild.value;
            });
            debugger

            data.med_dosage=data.med_dosage+' '+data.dosage_uom;
            data.med_timings=Number(!!data.timings_morning)+'-'+Number(!!data.timings_afternoon)+'-'+Number(!!data.timings_night);
            var duration=data.days || data.weeks ||  data.months;
            data.med_duration=data.med_duration+' '+duration;
            if($('.form').attr('data-id')){
				data.prescription_id = $('.form').attr('data-id')
				prescription_data = prescription_data.filter(function(p){
				    return p.prescription_id != data.prescription_id;
				})
            }
            prescription_data.push(data);
            showPrescriptions(prescription_data);
            $('.form').hide(1000);
            //$("#form3").get(0).reset();
        });
        $("#save_continue").on("click",function(evt) {
            getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then (function (res) {
                showPrescriptions(res.prescription_details);
               var next = $('#mytabs li.active').next();
                next.length?
                    next.find('a').click():
                    $('#mytabs li a')[2].click();
            });
            evt.preventDefault();
        });
		$('#tab1').on('click', '.edit' ,function (ev) {
		    debugger
			var id = ev.currentTarget.id.split('_')[1];
			var prescription = prescription_data.filter(function (p) {
				return p.prescription_id == id
            });
			if(prescription.length){
			    prescription = prescription[0];
			}
			$('.form').attr('data-id', prescription.prescription_id);
			$('#med_name').val(prescription.med_name);
			$('.med_type_div option[value="'+prescription.med_type+'"]').attr('selected', true);
			$('.dosage-div option[value="'+prescription.med_dosage.split(' ')[0]+'"]').attr('selected', true);
			$('.medicin-unit .dosage-mg').removeClass('active').addClass(prescription.med_dosage.split(' ')[1] == 'mg' ? 'active' : '');
			$('.medicin-unit .dosage-ml').removeClass('active').addClass(prescription.med_dosage.split(' ')[1] == 'ml' ?'active' : '');
            $('.timings #mrng').removeAttr('checked').attr('checked', prescription.med_timings.split('-')[0] == 1);
			$('.timings #noon').removeAttr('checked').attr('checked', prescription.med_timings.split('-')[1] == 1);
			$('.timings #night').removeAttr('checked').attr('checked', prescription.med_timings.split('-')[2] == 1);
            $('.timings .morning').removeClass('active').addClass( prescription.med_timings.split('-')[0] == 1 ? 'active' : '');
            $('.timings .noon').removeClass('active').addClass( prescription.med_timings.split('-')[1] == 1 ? 'active' : '');
            $('.timings .night').removeClass('active').addClass(prescription.med_timings.split('-')[2] == 1 ? 'active' : '');
			$('input[name="med_dosage_text"]').val(prescription.med_dosage_text ? prescription.med_dosage_text : '');
			$('input[name="med_duration"]').val(prescription.med_duration.split(' ')[0]);
            $('input[name="'+prescription.med_duration.split(' ')[1]+'"]').attr('checked', true);
            $('.food .food_timings_before').removeClass('active').addClass(prescription.food_timings == 'Before Food' ? 'active' : '');
			$('.food .food_timings_after').removeClass('active').addClass(prescription.food_timings == 'After Food' ? 'active' : '');
			$('textarea[name="instructions"]').text(prescription.instructions);
			$('.form').show(1000);
        });
        $('#tab1').on('click', '.delete',  function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            prescription_data = prescription_data.map(function (p) {
                if(p.prescription_id == id){
                    p.delete_flag = 'Y';
				}
				return p;
			});
            showPrescriptions(prescription_data);
        });
        /*	$("#autocomplete").autocomplete(function (evt) {
                getData.getMymedicineList(med);
                evt.preventDefault();
            });
    */
        /*$("#autocomplete").autocomplete(function(evt){
            debugger
            var formData=$("#autocomplete").serializeArray();
            var data={};
            formData.map(function(feild){
                data[feild.name]=feild.value;
            });
            medicine_data.push(data);
            getData.getMymedicineList(medicine_data);
            evt.preventDefault();
        });*/

    });
</script>
