<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
<script  type="text/x-handlebars-template" id="prescriptiontable">
	{{#prescription}}
	<tr>
		<td>{{med_type}}</td>
		<td>{{med_name}}</td>
     
		<td>{{frequency_string}}</td>
		<td>{{course}}</td>
		<td>{{med_intake}}</td>
		<td>{{remarks}}</td>
		<td>
			<span class="edit" id="e_{{prescription_id}}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></span>
			<span class="delete" id="d_{{prescription_id}}"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i></span>
		</td>
	</tr>
	{{/prescription}}
</script>
<div class="col-xs-12 appointment-details">
	<div class="form">
		<form id="form3" method="post">
			<div class="form-group">

				<div class="col-2 pull-right">
					<button type="button" class="close" id="pres_close" aria-label="Close">
						<span id="close-button" aria-hidden="true"><h3>&times;</h3></span>
					</button>
				</div>
			</div>
			<div class="row">
				<div class="col-4">
					<select class="custom-select form-control form-control-sm" id="med_type" name="med_type" required>
						<option value="tablet">Tablet</option>
						<option value="syrup">Syrup</option>
						<option value="drops">drops</option>
						<option value="suppositorie">Suppositorie</option>
						<option value="inhaler">Inhalers</option>
						<option value="injection">Injections</option>
						<option value="ointment">Ointment/Cream/Lotion</option>
						<option value="implants">Implants or patches</option>
					</select>
				</div>
				<div class="col-8">
					<div class="ui-front">
						<input class="form-input" name="med_search" id="med_search" placeholder="medecin name *" required>

						</input>
					</div>

				</div>


			</div>


			<div class="timings mt-3">
				<ul class="nav nav-tabs">
					<li><a href="#" id="standard" class="selected">Standard</a></li>
					<li><a href="#" id="free-text">Free Text</a></li>
				</ul>

				<div id="standard-tab">
					<div class="row">
						<div class="col-3">
							<div class="font-12">Morning *</div>
							<i class="fa fa-plus" aria-hidden="true" for="morning"></i>
								<input type="number" name="morning" id="morning"  class="quantity form-input" value="0" min="0">
							<i class="fa fa-minus" aria-hidden="true" for="morning"></i>
							<span class="unit"></span>
						</div>
						<div class="col-3">
							<div class="font-12">Afternoon *</div>
							<i class="fa fa-plus" aria-hidden="true" for="afternoon"></i>
							<input type="number" name="afternoon" id="afternoon" placeholder="Afternoon" class="quantity form-input" value="0" min="0">
							<i class="fa fa-minus" aria-hidden="true" for="afternoon"></i>
							<span class="unit"></span>
						</div>
						<div class="col-3">
							<div class="font-12">Night *</div>
							<i class="fa fa-plus" aria-hidden="true" for="evening"></i>
							<input type="number" name="night" id="evening" placeholder="Night" class="quantity form-input" value="0" min="0">
							<i class="fa fa-minus" aria-hidden="true" for="evening"></i>
							<span class="unit"></span>
						</div>
						<div class="col-sm-3 food">
							<label class="custom-control custom-radio">
								<input id="before-food" name="med_intake" type="radio" value="Before Food"  class="custom-control-input">
								<span class="custom-control-indicator"></span>
								<span class="custom-control-description">Before Food</span>
							</label>
							<label class="custom-control custom-radio">
								<input id="after-food" name="med_intake" type="radio" value="After Food" class="custom-control-input">
								<span class="custom-control-indicator"></span>
								<span class="custom-control-description">After Food</span>
							</label>
						</div>
					</div>
				</div>
				<div id="free-text-tab">
					<textarea name="med_dosage_text" id="timings-text" rows="3" placeholder="Provide the timings details."/>
					<div>
						Suggestions: <span id="suggestions"><a href="#">For Every 3 hours</a>, <a  href="#">7:30 AM - 10:30 AM - 1:30 PM - 4:30 PM</a></span>
					</div>
				</div>


			</div>

			<div class="form-group row mt-3">

				<div class="col-sm-3">
					<input type="number" name="course" placeholder="Duration *" min=0 class="form-input">
				</div>
				<div class="col-sm-4 duration">
					<label class="custom-control custom-radio">
						<input id="days" name="duration" type="radio" value="days" class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Days</span>
					</label>
					<label class="custom-control custom-radio">
						<input id="weeks" name="duration" type="radio" value='weeks' class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Weeks</span>
					</label>
					<label class="custom-control custom-radio">
						<input id="months" name="duration" type="radio" value='months' class="custom-control-input">
						<span class="custom-control-indicator"></span>
						<span class="custom-control-description">Months</span>
					</label>
				</div>

			</div>

			<div class="form-group">
				<textarea class="form-control" id="exampleTextarea" name="remarks" placeholder="remarks..." rows="3"></textarea>
			</div>

			<div class="form-group rows">
				<button class="btn btn-success btn-sm" id="add-prescription">Add</button>
				<button class="btn btn-danger btn-sm" id="reset-prescription" type="reset">Reset</button> <span class="form-error hidden-xs-up">Please add all mandatory fields</span>

			</div>
		</form>
	</div>
	<hr/>
	<div>
		<div class="row">
			<div class="col-7">
				<b>Prescribed Medications</b>
			</div>
			<div class="col-3 pull-right">
				<select class="template_name form-control" name="template_name" id="template_name">	</select>
			</div>
			<div class="col-1">
				<div id="add" class="btn btn-default fa fa-plus float-right btn-primary btn-sm"></div>
			</div>
		</div>


		<table class="table table-sm prescriptions-table">
			<thead>
			<tr>
				<th><b>Type</b></th>
				<th><b>Name</b></th>
           		<th><b>Timings/Quantity</b></th>
				<th><b>Course Duration</b></th>
				<th><b>Medicine Intake</b></th>
				<th><b>Instructions</b></th>
				<th id="strong"><b>Action</b></th>
			</tr>
			</thead>
			<tbody id="tab1">
			<tr >
				<td>
					Please add Prescriptions.
				</td>
			</tr>

			</tbody>
		</table>
		<button class="btn btn-primary btn-sm" id="save_continue">Save & Continue</button>
	</div>

</div>
<div class="template modal fade bd-example-modal-lg" id="template-alert" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="template-msg modal-dialog modal-sm" role="document">
            <div class=" modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Template</h4>
                </div>
                <div class="modal-body-template">
                Do you want to replace the existing medicines or append it?
                </div>
                <div class="modal-footer text-center">
                    <button type="button" class="btn btn-info btn-sm" id="replace" data-dismiss="modal" >Replace</button>
                    <button type="button" class="btn btn-primary btn-sm" id="append" data-dismiss="modal" >Append</button>
                </div>
            </div>
        </div>
    </div>

</div>
<script type="text/javascript">
	var prescriptionDetais = {
	    tablet: {
	        unit: "NO.",
            baseQuantity: 0.5,
			min: 0,
			max: 10,
			element: 'standerd',
			suggestions: ["Every 3 hours", "3 times a day"]
		},
        capsule: {
            unit: "NO.",
            baseQuantity: 1,
            min: 0,
            max: 10,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        syrup: {
            unit: "ML",
            baseQuantity: 2.5,
            min: 0,
            max: 20,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        drops: {
            unit: "Drops",
            baseQuantity: 1,
            min: 0,
            max: 10,
            element: 'freetext',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        suppositorie: {
            unit: "NO.",
            baseQuantity: 0.5,
            min: 0,
            max: 10,
            element: 'standerd',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        inhaler: {
            unit: "ML",
            element: 'freetext',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
        injection: {
            unit: "NO.",
            element: 'freetext',
            suggestions: ["Every 3 hours", "3 times a day"]
        },
		ointment: {
			element: "freetext",
            suggestions: ["Every 3 hours", "3 times a day"]
        },
		implants: {
	        element: "freetext"
		}
	}
    $(document).ready(function() {

        var prescription_data = [];
        var selectedPrescriptionDetails = prescriptionDetais.tablet;
        function setUnit() {
            selectedPrescriptionDetails = prescriptionDetais[$('#med_type').val()];
            $('.unit').html("");
            $('.quantity').removeAttr("min");
            $('.quantity').removeAttr("max");
            if(selectedPrescriptionDetails.unit){
                $('.unit').html(selectedPrescriptionDetails.unit);
            }
            if(selectedPrescriptionDetails.min){
                $('.quantity').prop("min", selectedPrescriptionDetails.min);
            }
            if(selectedPrescriptionDetails.max){
                $('.quantity').prop("max", selectedPrescriptionDetails.max);
            }
            if(selectedPrescriptionDetails.element === "freetext"){
                $('#free-text').click();
                selectedPrescriptionDetails.suggestions && $('#suggestions').html(selectedPrescriptionDetails.suggestions.map(function (value) { return "<a href='#'>"+value+"</a>" }).join(','));
            }else{
                $('#standard').click();
            }
        }
        setUnit();
		$('#med_type').on('change',function (ev) {
			setUnit();
        })
        $("#template_name").select2({
            width: '200px',
            tags: true,
            placeholder: "Search for a template",
            allowClear: true,
            containerCssClass : "custom-select ",
            ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                type: "post",
                url: base_url+"/api/getPrescriptionTemplateList.php",
                dataType: 'json',
           //     contentType: 'application/json; charset=UTF-8',
                quietMillis: 250,
                data: function (term) {
                    return JSON.stringify({
                        template_input : {
                        	doctor_id: doctor_id,
                          	//doctor_id: 1,
                            template_id: 1,
                            template_name:term.term,
                            speciality: ""
                        }
                    })
                },
                processResults: function (data) { // parse the results into the format expected by Select2.
                    // since we are using custom formatting functions we do not need to alter the remote JSON data

                    return {
                        results: $.map(data.template_det, function (smthg) {
                           return {id: smthg.template_id, text: smthg.template_name}
                        })
                    };
                }
            },
            cache: true
		}).addClass('custom-select ');

        $('#template_name').on('select2:select', function (e) {
            var template_id = $(this).val();
              var template_name=$("#template_name").text();         
            
            getData.getMyprescriptionTemplateDetails(template_id).then(function (res) {
             
                $(".modal-header").html(template_name);
                $('#template-alert').modal({
                    show: true
                });
                $("#replace").on("click", function (evt) {
                    showPrescriptions(res.prescription_details);
                    evt.preventDefault();
                });
                $("#append").on("click", function (evt) {
                    //  var prev_data = showPrescriptions(res.prescription_details);
                    getData.getMyprescriptionTemplateDetails(template_id).then(function (res) {
                    //debugger
                    prescription_data =prescription_data.concat(res.prescription_details);
                    showPrescriptions(prescription_data);
                });
                evt.preventDefault();
                });

            });
        });

/*  Code start for append and replace  */

        
    



/*  code end here for append and replace  */
        $("#med_search").autocomplete({
            minLength: 3,
            placeholder: "Search for a template",
            allowClear: true,
            classes: {
                "ui-autocomplete": "menu"
            },
            source: function(req, response){
                getData.getMymedicineList(req.term).then(function(res){
                    response(res.my_medicine.map(function (t) { return {label:t.med_brand_name, id:t.med_id} }));
                });;
            }
        });

        $("select").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);

            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });
        $('#med_search').change(function(){
            var med_name = $('#med_search').val();
            $("#med_name").val=med_name;
          // alert("med name:"+med_name);
        });

        if (prescriptions_list) {
            prescription_data = prescriptions_list;
        }
        $('.form').hide();
        
        $('#add').on('click', function (ev) {
            $(this).hide();
            $("#form3").get(0).reset();
            $('.form').show();
            ev.stopPropagation();
        });
        $("#close-button").on('click', function (ev) {
             $('#add').show();
            $('.form').hide();
            $("#form3").get(0).reset();
            $("#med_name").val("");
            ev.stopPropagation();
        })
        var showPrescriptions = function (prescriptions_list) {
            prescription_data = prescriptions_list;
            var source = $("#prescriptiontable").html();
            var template = Handlebars.compile(source);
            var rows = prescriptions_list.map(function (data) {
                if (!data.delete_flag || data.delete_flag != 'Y') {
                    if(!!data.med_id){
                        data.prescription_id = data.med_id;
                    }
                    return template({prescription: data});
                }
                //alert(({prescription:data}));
            });
            $('#tab1').html(rows.join(''));
        };
        if (apmt_status == "closed") {
            $("#add").hide();
            $("#save_continue").hide();
            $("#strong").hide();
            $(".edit").hide();
            $(".delete").hide();
            $('#template_name').hide();
        }
        //  $("#form4").hide()
        showPrescriptions(prescription_data);
        function validateForm(formData){
            var isValid = true;
            $('.form-error').addClass('hidden-xs-up')
            $('#med_search').removeClass('error');
           if(formData['med_name'] == ""){
               $('#med_search').addClass('error');
               isValid =false;
           }
           $('#med_type').removeClass('error');
            $('.quantity').removeClass('error');
            $('#timings-text').removeClass('error');

            if(formData['frequency_type'] == "std_MAE" && formData['frequency_string'] == "0-0-0"){
                $('.quantity').addClass('error');
                isValid = false;
           }else if(formData['frequency_type'] == "Others" && formData['frequency_string'].trim() == ""){
                isValid = false
                $('#timings-text').addClass('error');
            }
            $('input[name="course"]').removeClass('error');
    		if($('input[name="course"]').val() == ""){
                $('input[name="course"]').addClass('error');
                isValid = false;
            }
            if(!isValid){
    		    $('.form-error').removeClass('hidden-xs-up');
			}
            return isValid;
        }
        $("#add-prescription").click(function (evt) {
              $('#add').show();
            var formData = $("#form3").serializeArray();
            evt.preventDefault();
			//debugger
            var data = {};
            formData.map(function (feild) {
                data[feild.name] = feild.value;
            });
            data.dosage = data.dosage + ' ' + data.dosage_uom;
             //debugger
            if(!data.med_dosage_text){
                frequency_string = data.morning + '-' + data.afternoon + '-' + data.night;
                frequency_type= "std_MAE";
                /*data.frequency_string = data.morning + '-' + data.afternoon + '-' + data.night;
                data.frequency_type= "std_MAE";*/
            }else{
                frequency_string = data.med_dosage_text;
                frequency_type = "Others";
               /* data.frequency_string = data.med_dosage_text;
                data.frequency_type = "Others";*/
            }
                data.frequency_string =  frequency_string;
                data.frequency_type = frequency_type;

          // data.frequency = Number(!!data.morning) + '-' + Number(!!data.afternoon) + '-' + Number(!!data.night);
            data.course = data.course + ' ' + data.duration;
            data.med_name=data.med_search;
            if(validateForm(data)){
                if ($('.form').attr('data-id')) {
                    data.prescription_id = $('.form').attr('data-id')
                    prescription_data = prescription_data.filter(function (p) {
                        return p.prescription_id != data.prescription_id;
                    })
                }
                prescription_data.push(data);
                showPrescriptions(prescription_data);
                $('.form').hide();
			}
            //$("#form3").get(0).reset();
        });
        $("#save_continue").on("click", function (evt) {
            getData.UpdatePrescriptionDetails(appointment_id, prescription_data).then(function (res) {
                showPrescriptions(res.prescription_details);
                var next = $('#mytabs li.active').next();
                next.length ?
                    next.find('a').click() :
                    $('#mytabs li a')[2].click();
            });
            evt.preventDefault();
        });
        $('#tab1').on('click', '.edit', function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            var prescription = prescription_data.filter(function (p) {
                return p.prescription_id == id
            });
            if (prescription.length) {
                prescription = prescription[0];
            }
            $('.form').attr('data-id', prescription.prescription_id);
            $('#med_search').val(prescription.med_name);
            $('.med_type_div option[value="' + prescription.med_type + '"]').attr('selected', true);
            $('.timings #morning').val(prescription.frequency_string.split('-')[0]);
            $('.timings #afternoon').val(prescription.frequency_string.split('-')[1]);
            $('.timings #night').val(prescription.frequency_string.split('-')[2]);
            $('input[name="med_dosage_text"]').val(prescription.med_dosage_text ? prescription.med_dosage_text : '');
            $('input[name="course"]').val(prescription.course.split(' ')[0]);
            $('.duration input[value="' + prescription.course.split(' ')[1] + '"]').attr('checked', true);
            $('input[value="' + prescription.med_intake + '"]').attr('checked', true);
            $('textarea[name="remarks"]').text(prescription.remarks);
            $('.form').show();
        });
        $('#tab1').on('click', '.delete', function (ev) {
            var id = ev.currentTarget.id.split('_')[1];
            if (confirm('Are you sure want to delete this medicine?')) {
                prescription_data = prescription_data.map(function (p) {
                    if (p.prescription_id == id) {
                        p.delete_flag = 'Y';
                    }
                    return p;
                });
                showPrescriptions(prescription_data);
            }
        });
        $('#free-text-tab').hide();
        $('#standard').click(function (ev) {
            $('#standard').addClass('selected');
            $('#free-text').removeClass('selected');
			$('#standard-tab').show();
			$('#free-text-tab').hide();
        });
        $('#free-text').click(function (ev) {
            $('#free-text').addClass('selected');
            $('#standard').removeClass('selected')
            $('#standard-tab').hide();
            $('#free-text-tab').show();
        });
        $('.timings .fa-plus').on('click', function (ev) {
			var target = $(this).attr('for')
			var currentValue = $('#'+target).val();
			currentValue = !!currentValue ? Number(currentValue) : undefined;
			if(currentValue){
			    currentValue+=prescription.baseQuantity;
			}else{
			    currentValue=prescription.baseQuantity;
			}
            $('#'+target).val(currentValue);
			ev.stopPropagation();
        });
        $('.timings .fa-minus').on('click', function (ev) {
            var target = $(this).attr('for')
            var currentValue = $('#'+target).val();
            currentValue = !!currentValue ? Number(currentValue) : undefined;
            if(currentValue){
                currentValue-=prescription.baseQuantity;
            }else{
                currentValue=prescription.baseQuantity;
            }
            $('#'+target).val(currentValue);
            ev.stopPropagation();
        });
        $('#suggestions a').on('click', function (ev) {
            var text = $(this).text();
			$('#timings-text').text(text);
        })
    })
        /*	$("#autocomplete").autocomplete(function (evt) {
                getData.getMymedicineList(med);
                evt.preventDefault();
            });
    */
            /*$("#autocomplete").autocomplete(function(evt){
                debugger
                var formData=$("#autocomplete").serializeArray();
                var data={};
                formData.map(function(feild){
                    data[feild.name]=feild.value;
                });
                medicine_data.push(data);
                getData.getMymedicineList(medicine_data);
                evt.preventDefault();
            });*/
</script>