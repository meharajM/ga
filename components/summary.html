
<script  type="text/x-handlebars-template" id="summarytable">

    I would like to summarize the online consultation with <b>Dr. NISHANT</b> on <b>	{{appointments_det.apmt_date}}</b> as below: <br>
    <b>Diagnosis: </b>{{Diagnosis}}<br>
    <b>Management Plan: </b>{{mgmt_plan}}<br>
    <b>Next Follow-up in: </b>{{followup_in}}<br>
    <b>Next Follow-up Consultation: </b>{{followup_date}}<br>
    <b>Suggested Tests: </b>{{suggested_test}}<br>
    <b>Suggested Investigations: </b>{{ga_notes}}<br>
    <b>Referred to Doctor: </b>{{reffered_doctor}}<br>
    </p>
    <p>
        Regards,<br>
        Dr. Nishant Verma
    </p>
    <p>
        (This is electronically generated consultation summary. Signature not required.)
    </p>


</script>
<div class="container">
    <div class="row">
        <div class="col-xs-12 col-md-12 font-14" style="display:block;width:100%; padding-bottom:10px">
            <br>

            <form id="form4" method="get" data-toggle="validator" role="form" name="summary-form">
                <div class="form-group">
                    <label class="font-12 control-label required field" for="diagnosis"><b>Patient Diagnosis / Diagnoses</b><span class="asteriskField">*</span></label>

                    <div class="input-group">
                        <input class="form-control col-md-6 form-input" type="text" id="diagnosis" name="diagnosis" placeholder="Enter diagnosis / diagnoses" title="Please enter Diagnosis" />

                    </div>
                </div>

                <div class="form-group">

                    <label class="control-label required field font-12" for="plan"><b>Management Plan / Advice</b><span class="asteriskField">*</span></label>

                    <div class="input-group">
                        <textarea class="form-control col-md-6" cols="40" id="mgmt_plan" name="mgmt_plan" rows="3" placeholder="Enter Management Plan"  title="Please enter details"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label font-12" for="radio">
                        <b> Changes made to current medication?</b>
                    </label>
                    <div class="form-group row">
                        <div class="col-sm-4">
                            <div class="medicin-unit">
                                <div class="btn-group" data-toggle="buttons">
                                    <label class="btn btn-light active">
                                        <input type="radio" name="change_medication" autocomplete="off"> Yes
                                    </label>
                                    <label class="btn btn-light">
                                        <input type="radio" name="change_medication" autocomplete="off"> No
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">

                    <label class="control-label font-12" for="waive">
                        <b>Waive Fee for this Consultation?</b>
                    </label>
                    <!-- <div class="row"> -->
                    <div class="form-group row">
                        <div class="col-sm-4 col-md-3" >
                            <div class="medicin-unit">
                                <div class="btn-group waiver" data-toggle="buttons">
                                    <label class="btn btn-light active No_fee">
                                        <input type="radio" name="waiver_status" value="No" id="No_fee" autocomplete="off" checked="checked"> No
                                    </label>
                                    <label class="btn btn-light Full_fee">
                                        <input type="radio" name="waiver_status" value="Full" id="Full_fee" autocomplete="off"> Full
                                    </label>
                                    <label class="btn btn-light Partial_fee">
                                        <input type="radio" name="waiver_status" value="Partial" id="Partial_fee" autocomplete="off"> Partial
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 input-control" id="ifPartial" style="display: none">
                            <label class="control-label">
                                <input class="form-control form-input" type="text" name="waived_amount" id="p_check" autocomplete="off">
                            </label>
                        </div>
                    </div>
                </div>




                <div class="form-group">
                    <label class="control-label font-12" for="follow_up">
                        <b>Next Follow-up?</b>
                    </label>


                    <div class="form-group row">
                        <div class="col-md-3 col-sm-12">
                            <div class="dropdown">


                                <select class="followup form-control" name="followup_in" id="follow_up">
                                    <option name="followup_in" selected>Select</option>
                                    <option id="After_2_Days">After 2 Days</option>
                                    <option id="After_1_Week">After 1 Week</option>
                                    <option id="After_10_Days">After 10 Days</option>
                                    <option id="After_2_Weeks">After 2 Weeks</option>
                                    <option id="After_1_Month">After 1 Month</option>
                                    <option id="Others">Others</option>
                                </select>


                                <!--  <ul class="dropdown-menu text-center">
                                      <li id="After_1_Week" name="followup_in">After 1 Week</li>
                                      <li id="After_10_Days" name="followup_in">After 10 Days</li>
                                      <li id="After_2_Weeks" name="followup_in">After 2 Weeks</li>
                                      <li id="After_1_Month" name="followup_in">After 1 Month</li>
                                  </ul>-->
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-12">
                            <div class="input-group">
                                <input class="form-control form-input" type="text" id="followup_date" name="followup_date" />
                                <div class="input-group-addon form-input" id="cal">
                                    <i class="fa fa-calendar-times-o"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="form-group">
                    <label class="control-label font-12" for="suggested_test">
                        <b>Suggested Tests</b>
                    </label>
                    <div class="input-group">
                        <input class="form-input form-input" name="suggested_test" id="suggested_test" placeholder="Suggested Test">
                     <!--   <select class="test_id col-md-6" multiple="" name="suggested_test" id="suggested_test"></select>-->
                    </div>
                    <div id="suggested_test_list" class="m-1">

                    </div>
                </div>

                <div class="form-group ">

                    <label class="control-label font-12" for="refer">
                        <b>  Referred to Doctor (Optional)</b>
                    </label>
                    <div class="input-group">
                        <input class="form-control col-md-6 form-input" id="reffered_doctor" name="reffered_doctor" type="text" />
                    </div></div>

            </form>
            <div class="form-group-inline">
                <button class="btn btn-success" id="save" type="submit">Save</button>
                <button class="btn btn-info text-center" id="preview_summary" >Preview Summary</button>
                <button class="btn btn-danger" id="close">Close</button>

               <!--    <button class="btn btn-primary col-md-2" id="print">Print</button> -->

               <a href="#"  rel={{record_id}} id="print" data-target="#printPDF" data-toggle="modal" class="btn btn-primary">Print</a>

                <span class="summary-form-error"></span>
            </div>
        </div>


        <!--  <button class="btn-primary btn-sm text-center" id="close_consultation">Close Consultation</button>-->
        <!-- <div class="pdf">
         <button class="btn-success btn-lg text-center" id="generate_pdf">Generate PDF</button>
         </div>-->
        <div class="generate">
            <button class="btn btn-info btn-sm" id="edit_summary">Back</button>
            <div class="generate_preview"></div>
        </div>
        </div>

<!--Modal to display pdf inside modal onclick print button  starts here-->
                <div class="modal fade bd-example-modal-lg" id="printPDF" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                <div class="modal-header">
                <span class="document-title"></span>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">

                </div>

                </div>
                </div>
                </div>
<!--Modal to display pdf inside modal onclick print button  end here-->




       <!--  <div class="modal fade bd-example-modal-lg" id="summary-prev"
        class="summary-prev"  tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Consultation Summary</h4>
                    </div>
                    <div class="modal-body-summary">

                    </div>

                </div>
            </div>
        </div> -->
        <div class="close-consultation modal fade bd-example-modal-lg" id="close-consultation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="close-consult modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Close Consultation</h4>
                    </div>
                    <div class="modal-close-consultation">
                        Do you want to close the current Consultation? You will not be able to edit details after closing the Consulation!!                    </div>
                    <div class="modal-footer text-center">
                        <button type="button" class="btn btn-success" id="close-yes" data-dismiss="modal" >Yes</button>
                        <button type="button" class="btn btn-primary" id="close-no" data-dismiss="modal" >No</button>
                    </div>
                </div>
            </div>
        </div>
    </div>




<script type="text/javascript">
    $(document).ready(function() {
        $("#print").hide();
        var rec_id;
        function validateForm(formData){
//console.log($('#followup_date').val());
            var fdate = $('#followup_date').val();
            var isValid = true;
            $('.form-error').addClass('hidden-xs-up');
            $('#diagnosis').removeClass('error');
            $('#mgmt_plan').removeClass('error');
            $('#followup_date').removeClass('error');
            $('.form-error').text('');

            if($('#diagnosis').val() == ''){
                $('#diagnosis').addClass('error');
                isValid =false;
            }
            if($('#mgmt_plan').val() == ''){
                $('#mgmt_plan').addClass('error');
                isValid =false;
            }
            if(fdate  == ''){
                $('#followup_date').addClass('error');
                isValid =false;
            }

            if(isValid == false){
                $('.summary-form-error').text('Please fill the mandatory column');
            } else{
                $('.summary-form-error').text('');
            }

            return isValid;
        }


        // var consultation_id;
        var suggested_test_list = [];
        $("#suggested_test").autocomplete({
            minLength: 3,
            placeholder: "Search for a template",
            allowClear: true,
            classes: {
                "ui-autocomplete": "test"
            },
            source: function(req, response){

                getData.getLabTest(req.term).then(function(res){
                    response(res.labTest.tests.map(function (t) { return {label:t.labtest_name, id:t.labtest_id} }));
                });;
            },
            select: function (ev, ui) {
                
                ev.preventDefault();
                $(this).val("");
                if(suggested_test_list.indexOf(ui.item.id)){
                    suggested_test_list.push({test_id: ui.item.id, test_name: ui.item.label});
                    var tag = "<span class='tags'>"+ui.item.label+"<i class='fa fa-times ml-1' id='"+ui.item.id+"' aria-hidden='true'></i></span>";

                    $('#suggested_test_list').html($('#suggested_test_list').html() + tag);
                }
            }
        });
        $("select").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);

            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });
        $('.test_id').on('select2:select', function () {
            var test_id=$(".test_id").val();
            var test_name=$(".test_id").text();

            var suggested_test=[
                {
                    "test_id": test_id,
                    "test_name": test_name
                }];
            debug
            var data=JSON.stringify(suggested_test);
            console.log(data);
        });

        $("#preview_summary").on("click", function () {
            getData.previewConsultationSummary(appointment_id).then(function (res) {
                $(".generate").removeClass('d-none');
                $(".generate_preview").html(atob(res.document.body));
                $("#form4").hide();
                $("#save").hide();
                $("#preview_summary").hide();
                $("#close").hide();
            });
        });

        $("#print").click(function(){

            var  objbuilder = '';
            var data ='';
            getData.getDocumentBlobData(hs_id,summary_record_id).then(function (res) {
                data=res.document.doc_data;


                objbuilder += ('<object width="100%" height="100%" data="data:application/pdf;base64,');
                objbuilder += (data);
                objbuilder += ('" type="application/pdf" class="internal">');
                objbuilder += ('<embed src="data:application/pdf;base64,');
                objbuilder += (data);
                objbuilder += ('" type="application/pdf"  />');
                objbuilder += ('</object>');
                $('.modal-body').html(objbuilder);
            });

        })

        $("#edit_summary").on("click", function (evt) {
            $(".generate").addClass('d-none');
            $("#form4").show();
            $("#save").show();
            $("#preview_summary").show();
            $("#close").show();

        })

        var showSummary = function(data){
            var source   = $("#summarytable").html();
            var template = Handlebars.compile(source);
            $('#summary').html(template(data));
        };

        if(apmt_status=="closed"||apmt_status=="expired"){
            $("#save").hide();
            $("#preview_summary").hide();
            $("#edit_summary").hide();
            $("#close").hide();
            $("#start-vedio-consultation").hide();

            getData.previewConsultationSummary(appointment_id).then(function (res) {
                $(".generate").removeClass('d-none');
                $(".generate_preview").html(res);
            });
        }
        if((summary_details&&apmt_status=="closed")){
            $("#form4").show();
            $("#print").show();
            $("#start-vedio-consultation").hide();
        }
        if(summary_details !=""){
            if(summary_details && apmt_status=="closed"){
                $('#form4 :input').attr('readonly', 'readonly');
                $('#p_check').prop('readonly', true);
            }

            $("#diagnosis").val(summary_details.Diagnosis);
            $("#mgmt_plan").val(summary_details.mgmt_plan);
            $("#follow_up").val(summary_details.followup_in);
            $("#followup_date").val(summary_details.followup_date);
            $("#reffered_doctor").val(summary_details.reffered_doctor);
            if(summary_details.waive_fee == 'Full'){
                $('.Full_fee').addClass('active');
                $('.No_fee').removeClass('active');
                $('.Partial_fee').removeClass('active');
                $("#p_check")[0].disabled = false;
                $("#ifPartial").show();
                $("#p_check").val(summary_details.waived_amount);
                $('#p_check').attr('readonly', true);
                $("input[name='waiver_status']:checked").val(summary_details.waive_fee);
            }else if(summary_details.waive_fee == 'No'){
                $('.No_fee').addClass('active');
                $('.Full_fee').removeClass('active');
                $('.Partial_fee').removeClass('active');
                $("#ifPartial").hide();
                $("input[name='waiver_status']:checked").val(summary_details.waive_fee);
            }else {
                $('.Partial_fee').addClass('active');
                $('.Full_fee').removeClass('active');
                $('.No_fee').removeClass('active');
                $("#p_check")[0].disabled = false;
                $('#p_check').attr('readonly', false);
                $("#ifPartial").show();
                $("#p_check").val(summary_details.waived_amount);
                $("input[name='waiver_status']:checked").val(summary_details.waive_fee);
            }
            $("#p_check").val(summary_details.waived_amount);
        }



        $("#save").on("click",function(evt) {
            var formData = $("#form4").serializeArray();
            if(validateForm(formData)){
                evt.preventDefault();
                var data={};
                formData.map(function (feild) {
                    data[feild.name] = feild.value;
                });
                if(consultation_id) {
                    data.consultation_id=consultation_id;
                }
                data.suggested_test = suggested_test_list;
                
                getData.UpdateConsultationSummary(appointment_id,data).then(function (res) {
                    return res;
                });
            }
        });

        $("#close-yes").on("click", function (evt) {
            getData.closeConsultation(appointment_id).then(function(res){
                res.appointment_status=="closed";
                summary_record_id=res.consultation.record_id;

            });
            evt.preventDefault();
        });

        $("#close").on("click",function(evt) {
            //console.log(evt);
            $('#close-consultation').modal({
                show: true
            });

            evt.preventDefault();
        });

        $('#follow_up').change(function(){
            var followup_days = $('#follow_up').val();
            if(followup_days=="After 2 Days"){
                $("#followup_date").val(moment().add(2,'days').format("YYYY-MM-DD"));
            }
            if(followup_days=="After 1 Week"){
                $("#followup_date").val(moment().add(7,'days').format("YYYY-MM-DD"));
            }
            if(followup_days=="After 10 Days"){
                $("#followup_date").val(moment().add(10,'days').format("YYYY-MM-DD"));
            }
            if(followup_days=="After 2 Weeks"){
                $("#followup_date").val(moment().add(14,'days').format("YYYY-MM-DD"));
            }
            if(followup_days=="After 1 Month"){
                $("#followup_date").val(moment().add(30,'days').format("YYYY-MM-DD"));
            }
        });

        var date_input=$('input[name="followup_date"]'); //our date input has the name "date"
        var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
        date_input.datepicker({
            format: 'yyyy-dd-mm',
            container: container,
            todayHighlight: true,
            autoclose: true
        });
        $("input[name='waiver_status']").change(function(){
            if($(this).val()=="Partial"){
                $("#p_check")[0].disabled = false;
                $('#p_check').attr('readonly', false);
                $("#ifPartial").show();
                $("#p_check").val("");
            }else if($(this).val()=="Full"){
                $("#p_check")[0].disabled = false;
                $("#ifPartial").show();
                $("#p_check").val("1000");
                $('#p_check').attr('readonly', true);
            }else{
                $("#ifPartial").hide();
            }
        });
        $('#suggested_test_list').on('click', '.fa-times' ,function (ev) {
            
           var id = ev.target.id;
           suggested_test_list.splice(suggested_test_list.indexOf(id), 1);
           $(this).parent().remove();
        });
        //});
        /*  $("#print").on("click", function () {
            alert(123);
            getData.previewConsultationSummary(appointment_id).then(function (res) {
                window.open("data:application/pdf;base64, " + res.document.body);
            });
        });*/
        /* window.open("data:application/pdf;base64, " + res.document.body);*/
    });

</script>
<style>
.tags{
    height: 14px;
    background-color: #1f7bf3;
    color: #ffffff;
    line-height: 14px;
    padding: 4px;
    margin-left: 4px;
    font-size: 12px;
}
</style>