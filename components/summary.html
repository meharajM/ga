<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.1/css/select2.min.css" />
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-rc.1/js/select2.min.js"></script>
<!--
<script  type="text/x-handlebars-template" id="summarytable">

        I would like to summarize the online consultation with <b>Dr. NISHANT</b> on <b>	{{appointments_det.apmt_date}}</b> as below: <br>
        <b>Diagnosis: </b>{{consultation_details.consultation_summary.Diagnosis}}<br>
        <b>Management Plan: </b>{{consultation_details.consultation_summary.mgmt_plan}}<br>
        <b>Next Follow-up in: </b>{{consultation_details.consultation_summary.followup_in}}<br>
        <b>Next Follow-up Consultation: </b>{{consultation_details.consultation_summary.followup_date}}<br>
        <b>Suggested Investigations: </b>{{consultation_details.consultation_summary.ga_notes}}<br>
        <b>Referred to Doctor: </b>{{consultation_details.consultation_summary.reffered_doctor}}<br>
        </p>
        <p>
            Regards,<br>
            Dr. Nishant Verma
        </p>
        <p>
            (This is electronically generated consultation summary. Signature not required.)
        </p>
</script>-->

<script  type="text/x-handlebars-template" id="summarytable">

    I would like to summarize the online consultation with <b>Dr. NISHANT</b> on <b>	{{appointments_det.apmt_date}}</b> as below: <br>
    <b>Diagnosis: </b>{{Diagnosis}}<br>
    <b>Management Plan: </b>{{mgmt_plan}}<br>
    <b>Next Follow-up in: </b>{{followup_in}}<br>
    <b>Next Follow-up Consultation: </b>{{followup_date}}<br>
    <b>Suggested Tests: </b>{{suggested_test}}<br>
    <b>Suggested Investigations: </b>{{ga_notes}}<br>
    <b>Referred to Doctor: </b>{{reffered_doctor}}<br>
    </p>
    <p>
        Regards,<br>
        Dr. Nishant Verma
    </p>
    <p>
        (This is electronically generated consultation summary. Signature not required.)
    </p>


</script>
<div class="container">
    <div class="row">
        <div class="col-xs-12 col-md-12 font-14" style="display:block;width:100%; padding-bottom:10px">
            <br>

            <form id="form4" method="get" data-toggle="validator" role="form" name="summary-form">
                <div class="form-group">
                    <label class="control-label required field" for="diagnosis"><b>Patient Diagnosis / Diagnoses</b><span class="asteriskField">*</span></label>

                    <div class="input-group">
                        <input class="form-control col-md-6" type="text" id="diagnosis" name="diagnosis" placeholder="Enter diagnosis / diagnoses" title="Please enter Diagnosis" />

                    </div>
                </div>

                <div class="form-group">

                    <label class="control-label required field" for="plan"><b>Management Plan / Advice</b><span class="asteriskField">*</span></label>

                    <div class="input-group">
                        <textarea class="form-control col-md-6" cols="40" id="mgmt_plan" name="mgmt_plan" rows="3" placeholder="Enter Management Plan"  title="Please enter details"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label" for="radio">
                        <b> Changes made to current medication?</b>
                    </label>
                    <div class="form-group row">
                        <div class="col-sm-4">
                            <div class="medicin-unit">
                                <div class="btn-group" data-toggle="buttons">
                                    <label class="btn btn-light active">
                                        <input type="radio" name="change_medication" autocomplete="off"> Yes
                                    </label>
                                    <label class="btn btn-light">
                                        <input type="radio" name="change_medication" autocomplete="off"> No
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">

                    <label class="control-label" for="waive">
                        <b>Waive Fee for this Consultation?</b>
                    </label>
                    <!-- <div class="row"> -->
                    <div class="form-group row">
                        <div class="col-sm-4 col-md-3" >
                            <div class="medicin-unit">
                                <div class="btn-group waiver" data-toggle="buttons">
                                    <label class="btn btn-light active No_fee">
                                        <input type="radio" name="waiver_status" value="No" id="No_fee" autocomplete="off" checked="checked"> No
                                    </label>
                                    <label class="btn btn-light Full_fee">
                                        <input type="radio" name="waiver_status" value="Full" id="Full_fee" autocomplete="off"> Full
                                    </label>
                                    <label class="btn btn-light Partial_fee">
                                        <input type="radio" name="waiver_status" value="Partial" id="Partial_fee" autocomplete="off"> Partial
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4 input-control" id="ifPartial" style="display: none">
                            <label class="control-label">
                                <input class="form-control" type="text" name="waived_amount" id="p_check" autocomplete="off">
                            </label>
                        </div>
                    </div>
                </div>




                <div class="form-group">
                    <label class="control-label" for="follow_up">
                        <b>Next Follow-up?</b>
                    </label>


                    <div class="form-group row">
                        <div class="col-md-3 col-sm-12">
                            <div class="dropdown">


                                <select class="followup form-control" name="followup_in" id="follow_up">
                                    <option name="followup_in" selected>Select</option>
                                    <option id="After_2_Days">After 2 Days</option>
                                    <option id="After_1_Week">After 1 Week</option>
                                    <option id="After_10_Days">After 10 Days</option>
                                    <option id="After_2_Weeks">After 2 Weeks</option>
                                    <option id="After_1_Month">After 1 Month</option>
                                    <option id="Others">Others</option>
                                </select>


                                <!--  <ul class="dropdown-menu text-center">
                                      <li id="After_1_Week" name="followup_in">After 1 Week</li>
                                      <li id="After_10_Days" name="followup_in">After 10 Days</li>
                                      <li id="After_2_Weeks" name="followup_in">After 2 Weeks</li>
                                      <li id="After_1_Month" name="followup_in">After 1 Month</li>
                                  </ul>-->
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-12">
                            <div class="input-group">
                                <input class="form-control" type="text" id="followup_date" name="followup_date" />
                                <div class="input-group-addon" id="cal">
                                    <i class="fa fa-calendar-times-o"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="form-group">
                    <label class="control-label" for="suggested_test">
                        <b>Suggested Tests</b>
                    </label>
                    <div class="input-group">
                        <select class="test_id col-md-6" multiple="" name="suggested_test" id="suggested_test"></select>
                    </div>
                </div>

                <div class="form-group ">

                    <label class="control-label " for="refer">
                        <b>  Referred to Doctor (Optional)</b>
                    </label>
                    <div class="input-group">
                        <input class="form-control col-md-6" id="reffered_doctor" name="reffered_doctor" type="text" />
                    </div></div>

            </form>
            <div class="form-group-inline">
                <button class="btn btn-success col-md-2" id="save" type="submit">Save</button>
                <button class="btn btn-info col-md-2 text-center" id="preview_summary" data-toggle="modal" data-target="#summary-preview">Preview Summary</button>
                <button class="btn btn-danger col-md-2" id="close">Close</button>
            </div>
        </div>


        <!--  <button class="btn-primary btn-sm text-center" id="close_consultation">Close Consultation</button>-->
        <!-- <div class="pdf">
         <button class="btn-success btn-lg text-center" id="generate_pdf">Generate PDF</button>
         </div>-->
        <div class="generate">
            <button class="btn btn-danger" id="edit_summary">Edit Summary</button>
            <div class="generate_preview"></div>
        </div>



        </div>
        <div class="modal fade bd-example-modal-lg" id="summary-prev" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Consultation Summary</h4>
                    </div>
                    <div class="modal-body-summary">

                    </div>

                </div>
            </div>
        </div>
        <div class="close-consultation modal fade bd-example-modal-lg" id="close-consultation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="close-consult modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Close Consultation</h4>
                    </div>
                    <div class="modal-close-consultation">
                        Do you want to close the current Consultation? You will not be able to edit details after closing the Consulation!!                    </div>
                    <div class="modal-footer text-center">
                        <button type="button" class="btn btn-success" id="close-yes" data-dismiss="modal" >Yes</button>
                        <button type="button" class="btn btn-primary" id="close-no" data-dismiss="modal" >No</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


</body>
</html>

<script type="text/javascript">

function validateForm(formData){
        var isValid = true;
        $('.form-error').addClass('hidden-xs-up');
        $('#diagnosis').removeClass('error');
        $('#mgmt_plan').removeClass('error');
        $('#followup_in').removeClass('error');
        $('.form-error').text('');

        if($('#diagnosis').val() == ''){
            $('#diagnosis').addClass('error'); 
            isValid =false;             
        }

        if($('#mgmt_plan').val() == ''){
            $('#mgmt_plan').addClass('error');
            isValid =false;
        }

        if($('#followup_in').val() == ''){
            $('#followup_in').addClass('error');
            isValid =false;
        }

        if(isValid == false){
            $('.form-error').text('Please fuill the mandatory column');
        }     
}


    // var consultation_id;
    $(document).ready(function(){
        $(".generate").addClass('d-none');
        // var summary_data=[];
        $(".test_id").select2({
            tags: true,
            //minimumInputLength: 3,
            placeholder: "Select a test",
            allowClear: true,
            ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                type: "post",
                url: base_url+"/api/labTest.php",
                dataType: 'json',
                //   contentType: 'application/json; charset=UTF-8',
                quietMillis: 250,
                data: function (term) {
                    return JSON.stringify({
                        lab_tests: {
                            labtest_name: term.term
                        }
                    })
                },
                processResults: function (data) { // parse the results into the format expected by Select2.
                    // since we are using custom formatting functions we do not need to alter the remote JSON data

                    return {
                        results: $.map(data.labTest.tests, function (smthg) {
                            return {id: smthg.labtest_id, text: smthg.labtest_name}
                        })
                    };
                }
            },
            cache: true
            // formatSelection: formatSelection
        });
        $("select").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);

            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });
        $('.test_id').on('select2:select', function () {
            var test_id=$(".test_id").val();
            var test_name=$(".test_id").text();
            var suggested_test=[
                {
                    "test_id": test_id,
                    "test_name": test_name
                }
                        ];
            var data=JSON.stringify(suggested_test);
            console.log(data);
        });

        $("#preview_summary").on("click", function () {
            getData.previewConsultationSummary(appointment_id).then(function (res) {
              //  $(".modal-body-summary").html(res);
                  //  $(".generate_preview").html(res);
                $(".generate").removeClass('d-none');
                $(".generate_preview").html(res.document.body);
                $("#form4").hide();
                $("#save").hide();
                $("#preview_summary").hide();
                $("#close").hide();

            });

        });

        $("#edit_summary").on("click", function (evt) {
            $(".generate").addClass('d-none');
            $("#form4").show();
            $("#save").show();
            $("#preview_summary").show();
            $("#close").show();

        })

        /* $("#generate_pdf").hide();*/
        var showSummary = function(data){
            var source   = $("#summarytable").html();
            var template = Handlebars.compile(source);
            $('#summary').html(template(data));
        };

        if(apmt_status=="closed"||apmt_status=="expired")
        {
            $("#form4").hide();
            $("#save").hide();
            $("#preview_summary").hide();
            $("#edit_summary").hide();
            $("#close").hide();

            getData.previewConsultationSummary(appointment_id).then(function (res) {
                $(".generate").removeClass('d-none');
                $(".generate_preview").html(res.document.body);
            });
        }
        if((summary_details&&apmt_status=="closed")||(summary_details&&apmt_status=="expired"))
        {
            $("#form4").hide();
            getData.previewConsultationSummary(appointment_id).then(function (res) {
                $(".generate_preview").html(res.document.body);
            });
        }

        if ((summary_details && apmt_status=="booked")||(summary_details && apmt_status=="paid")||(summary_details && apmt_status=="released"))
        {
            $("#diagnosis").val(summary_details.Diagnosis);
            $("#mgmt_plan").val(summary_details.mgmt_plan);
            $("#follow_up").val(summary_details.followup_in);
            $("#followup_date").val(summary_details.followup_date);
            $("#reffered_doctor").val(summary_details.reffered_doctor);
           // $('.waiver option[value="' + summary_details.waive_fee + '"]').attr('checked', true);

            if(summary_details.waive_fee == 'Full'){
                $('.Full_fee').addClass('active');
                $('.No_fee').removeClass('active');
                $('.Partial_fee').removeClass('active');
                $("#p_check")[0].disabled = false;
                $("#ifPartial").show();
                $("#p_check").val(summary_details.waived_amount);
                $('#p_check').attr('readonly', true);
                $("input[name='waiver_status']:checked").val(summary_details.waive_fee);
            }else if(summary_details.waive_fee == 'No'){
                $('.No_fee').addClass('active');
                $('.Full_fee').removeClass('active');
                $('.Partial_fee').removeClass('active');
                $("#ifPartial").hide();
                $("input[name='waiver_status']:checked").val(summary_details.waive_fee);

            }else {
                $('.Partial_fee').addClass('active');
                $('.Full_fee').removeClass('active');
                $('.No_fee').removeClass('active');
                $("#p_check")[0].disabled = false;
                $('#p_check').attr('readonly', false);
                $("#ifPartial").show();
                $("#p_check").val(summary_details.waived_amount);
                $("input[name='waiver_status']:checked").val(summary_details.waive_fee);

            }

            // $("input[name='waiver_status']").val(summary_details.waive_fee).attr('selected', true);
            //$("input[name='waiver_status']").val()==summary_details.waive_fee;
            //debugger;
            /*$("input[name='waiver_status']").val(summary_details.waive_fee).attr('selected', true);
            $('.waiver .No_fee').removeClass('active').addClass(summary_details.waive_fee == 'No' ? 'active' : '');
            $('.waiver .Full_fee').removeClass('active').addClass(summary_details.waive_fee == 'Full' ? 'active' : '');
            $('.waiver .Partial_fee').removeClass('active').addClass(summary_details.waive_fee == 'Partial' ? 'active' : '');*/
          //  $("#ifPartial").show();
            $("#p_check").val(summary_details.waived_amount);
            //$('.followup option[value="' + summary_details.followup_in + '"]').attr('selected', true);
            /*    if($("input[name='waiver_status']").val(summary_details.waive_fee)=="No")
                {

                    $("#ifPartial").hide();
                }
                else if($(this).val()=="Full")
                {
                    $("#p_check")[0].disabled = false;
                    $("#ifPartial").show();
                    $("#p_check").val(summary_details.waived_amount);
                    $('#p_check').attr('readonly', true);

                }
                else
                {
                    $("#p_check")[0].disabled = false;
                    $('#p_check').attr('readonly', false);
                    $("#ifPartial").show();
                    $("#p_check").val(summary_details.waived_amount);
                }*/
        }



        $("#save").on("click",function(evt) {
            var formData = $("#form4").serializeArray();
            console.log(formData);
            evt.preventDefault();
            //  var data = {suggested_test: [{'1':"Blood"}, {'2':"Urea"}]};
            var data={};
            formData.map(function (feild) {
                data[feild.name] = feild.value;
            });
            if(consultation_id)
            {
                data.consultation_id=consultation_id;
            }
            getData.UpdateConsultationSummary(appointment_id,data).then(function (res) {
                return res;
            });
        });

        $("#close-yes").on("click", function (evt) {
            getData.closeConsultation(appointment_id).then(function(res){
                res.appointment_status=="closed";
            });
            getData.previewConsultationSummary(appointment_id).then(function (res) {
                $(".generate_preview").html(res.document.body);
            });
            evt.preventDefault();
        });

        $("#close").on("click",function(evt) {
           // alert("Do you want to close this Consultation? You wouldn't be able to edit details after closing the Consulation");
            $('#close-consultation').modal({
                show: true
            });
            evt.preventDefault();
        });

        $('#follow_up').change(function(){
            var followup_days = $('#follow_up').val();
            if(followup_days=="After 2 Days")
            {
                $("#followup_date").val(moment().add(2,'days').format("YYYY-MM-DD"));
            }
            if(followup_days=="After 1 Week")
            {
                $("#followup_date").val(moment().add(7,'days').format("YYYY-MM-DD"));

            }
            if(followup_days=="After 10 Days")
            {
                $("#followup_date").val(moment().add(10,'days').format("YYYY-MM-DD"));

            }
            if(followup_days=="After 2 Weeks")
            {
                $("#followup_date").val(moment().add(14,'days').format("YYYY-MM-DD"));

            }
            if(followup_days=="After 1 Month")
            {
                $("#followup_date").val(moment().add(30,'days').format("YYYY-MM-DD"));

            }
        });



        var date_input=$('input[name="followup_date"]'); //our date input has the name "date"
        var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
        date_input.datepicker({
            format: 'yyyy-dd-mm',
            container: container,
            todayHighlight: true,
            autoclose: true
        });
        $("input[name='waiver_status']").change(function(){
            if($(this).val()=="Partial")
            {
                $("#p_check")[0].disabled = false;
                $('#p_check').attr('readonly', false);
                $("#ifPartial").show();
                $("#p_check").val("");
            }
            else if($(this).val()=="Full")
            {
                $("#p_check")[0].disabled = false;
                $("#ifPartial").show();
                $("#p_check").val("1000");
                $('#p_check').attr('readonly', true);

            }
            else
            {
                $("#ifPartial").hide();
            }
        });
    });
</script>